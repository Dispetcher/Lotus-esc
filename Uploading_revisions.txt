%REM
	Agent Applications Uploading from esculap
	Created 29/01/2018 Dmitry Skoblikov
	Description: Comments for Agent
%END REM
Option Public
Option Declare

Public ExcelApp As Variant
Public ExcelSheet As Variant
Dim db As NotesDatabase
Dim s As NotesSession
Dim strError As String

Sub Initialize
	On Error GoTo handler 'обработчик ошибок
	REM +++++++++++++++++++++++++++++
	Dim ws As New NotesUIWorkspace
	Dim ret, path$, i%

	' Подключение к Excel
	On Error Resume Next
	Set ExcelApp = CreateObject("Excel.Application")
	If Err()<>0 Then MsgBox "Excel не установлен": End
	On Error GoTo handler

	REM +++
	' Выбираем файл для открытия
	ret = ws.Openfiledialog(False, "Выбор файла", "Excel_2013|*.xlsx|Excel_2010|*.xls", "D:\", )
	If IsEmpty(ret) Then GoTo endh
	path = ret(0)
	
	'Открытие файла
	On Error Resume Next
	Call ExcelApp.Workbooks.Add(path)
	If Err()<>0 Then Err=0 : Print "Ошибка при открытии " + path : GoTo endh
	On Error GoTo handler
	
	Set ExcelSheet = ExcelApp.Workbooks(1).Worksheets(1)
	If Err()<>0 Then Err=0 : Print "Ошибка ExcelApp.Workbooks(1).Worksheets(1) при открытии " : GoTo endh
	On Error GoTo handler
	
	
	' Определяем БД
	Set s = New NotesSession
	'Set db = s.CurrentDatabase
	
	For i=539 To 540
		Call FillRevisions(i)
	Next i

	ExcelApp.DisplayAlerts = False
	ExcelApp.Quit
	
	REM +++++++++++++++++++++++++++++
	GoTo endh
handler:
	ExcelApp.DisplayAlerts = False
	ExcelApp.Quit
	Dim strError As String
	strError = " Ошибка в Процедуре { Initialize } из Агента { Закачка заявлений из эскулапа }, строка " + CStr(Erl) + Chr(10) + Error$
	Error Err, strError
endh:
End Sub
%REM
	Function fillApps 25/12/17
	Description: Заявления
%END REM
Function FillRevisions(i As Integer)
	On Error GoTo handler 'обработчик ошибок
	REM +++++++++++++++++++++++++++++	
	Dim unid$, unidorg$, tmp$, tmp2$, opf$, pn$, kn$, inn$, inntmp$
	Dim innarr, unidorgarr, pnarr, knarr As Variant
	Dim doc, uidoc As NotesDocument
	Dim view As NotesView
	
	' Определяем БД
	Set db = s.Currentdatabase
	
	'Определяем организацию по ИНН и получаем ее UNID и данные
	inn = ExcelSheet.Cells(i,4).Value
	inn = Val(Trim(inn))
	
	Set view = db.getview("INNtoUNID")
	Set uidoc = view.Getfirstdocument()
	
	inntmp = Val(uidoc.Getitemvalue("INN")(0))
	
	While inn <> inntmp
		Set uidoc = view.Getnextdocument(uidoc)
		inntmp = Val(uidoc.Getitemvalue("INN")(0))
	Wend
	
	' Создаем документ в БД
	Set doc = db.Createdocument()
	
	On Error GoTo endh 'обработчик ошибок
	'Получаем SROUNID 
	unidorg = uidoc.Getitemvalue("OrgChlenSROUNID")(0) 
	'Получаем pn
	pn = uidoc.Getitemvalue("OrgChlenSROТName")(0)
	'Получаем kn
	kn = uidoc.Getitemvalue("OrgChlenSROТNameShow")(0)
	
	' Заполняем UNID
	unid =  doc.Universalid 
	Call doc.Replaceitemvalue("UNID", unid)
	' OrgChlenSROTName
	Call doc.Replaceitemvalue("OrgChlenSROТName", pn)	
	' OrgChlenSROUNID
	Call doc.Replaceitemvalue("OrgChlenSROUNID", unidorg)
	' OrgChlenSROTName
	Call doc.Replaceitemvalue("OrgChlenSROТNameShow", kn)	
	' Определяем имя формы
	Call doc.Replaceitemvalue("Form", "KontrolDejatelnostiProverki")
	
	' Тип проверки
	tmp = ExcelSheet.Cells(i,10).Value
	tmp = Trim(tmp)
	If tmp = "Первичная" Then 
		tmp2 = "0"
	ElseIf tmp = "Плановая" Then
		tmp2 = "1"
	ElseIf tmp = "Внеплановая" Then
		tmp2 = "2"
	End if
	Call doc.Replaceitemvalue("TipProverki", tmp2)	

	'Номер акта проверки
	tmp = ExcelSheet.Cells(i,6).Value
	tmp = Trim(tmp)
	Call doc.ReplaceItemValue("ActNum", tmp)
	
	'Дата акта
	tmp = ExcelSheet.Cells(i,5).Value
	Call doc.ReplaceItemValue("DateAct", tmp)

	'Дата начала
	tmp = ExcelSheet.Cells(i,14).Value
	Call doc.ReplaceItemValue("DateStart", tmp)
	
	'Дата окончания
	tmp = ExcelSheet.Cells(i,15).Value
	Call doc.ReplaceItemValue("DateStop", tmp)
	
	'Основание проверки
	tmp = ExcelSheet.Cells(i,11).Value
	tmp2 = ExcelSheet.Cells(i,12).Value
	tmp = tmp + " " + tmp2
	Call doc.ReplaceItemValue("OsnovanieProverki", tmp)

	'Форма проверки
	tmp = ExcelSheet.Cells(i,13).Value
	Call doc.ReplaceItemValue("FormaProverki", tmp)
	
	'Место проверки
	tmp = ExcelSheet.Cells(i,16).Value
	Call doc.ReplaceItemValue("MestoProverki", tmp)

	'ФИО проверяющего
	tmp = ExcelSheet.Cells(i,17).Value
	If tmp = "-не определено-" Then tmp=""
	Call doc.ReplaceItemValue("FIOProverjajuwih", tmp)
	
	Call doc.Save(True, True, True)	
	
	REM +++++++++++++++++++++++++++++
	GoTo endh
handler:
	ExcelApp.DisplayAlerts = False
	ExcelApp.Quit
	Dim strError As String
	strError = " Ошибка в { функции FillRevisions}, строка " + CStr(Erl) + Chr(10) + Error$
	'Error Err, strError
	MsgBox strError
	End
endh:
End Function